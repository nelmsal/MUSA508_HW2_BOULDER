# i. Pre-Clean Data

## 1 CRS
```{r import}

col_crs = st_crs('ESRI:102653')


```

# 1 House Sales
```{r import_sales}
print(getwd())
col_crs = st_crs('ESRI:102653')

studentData_path =
  "./data/studentData.geojson"
boulder.sales =
  st_read(studentData_path) %>% 
  st_set_crs('ESRI:102254') %>% 
  st_transform(., col_crs) %>%
  mutate(
    toPredict = toPredict %>% sapply(., as.character)
  ) %>%
  rename(id.musa = MUSA_ID)

boulder.sales$lagPrice = 0

boulder.variables = 
  data.frame(
    # 0. Housing Sales Price
    var_name  = c("price"),
    var_num   = (0),
    var_type  = ('Dependent')
    )

add_v = function(vnme, vnum, vtype){
  if(vnme %in% boulder.variables[['var_name']]){
    print("didnt add since it is already in")
    return(boulder.variables)
    }
  else{
    return(rbind(boulder.variables,c(
    vnme, vnum, vtype
    )) %>% arrange(var_num))}}

```

# 2 Parcel Joins
## A Main Import
```{r parcel}

################
# https://opendata-bouldercounty.hub.arcgis.com/datasets/parcels/explore

parcel_path =
  "./data/Boulder_Parcels_20211009.geojson"
boulder.parcel = st_read(parcel_path) %>%
  st_transform(., col_crs) #%>% # North Col State Plane Feet
  # mutate(
  #   geometry = st_make_valid(geometry),
  #   lot.sqft = st_area(geometry) %>% as.numeric()) %>% 
  #filter(lot.sqft>0)

"data/Boulder_Sales_Assessor_join.csv"
```


### 1 Join Sales & parcel
``` {r parcel_fix}
boulder.p.sales = 
  st_join(
    boulder.sales %>% 
      select(id.musa, address),
    boulder.parcel[boulder.parcel$id.apn != '157508Q01002',],
    quiet=TRUE
  ) %>% 
  select(id.musa,id.apn,address) %>%
  mutate_by(
    group=id.apn,
    count.apn = n()
  ) %>%
  mutate_by(
    group=id.musa,
    count.musa = n()
  ) %>%
  mutate_by(
    group=address,
    count.add = n()
  ) %>% 
  st_drop_geometry() %>% 
  arrange(desc(count.musa), desc(count.add), desc(count.apn))

# count_unique(boulder.p.sales$id.apn)
# count_unique(boulder.p.sales$id.musa)
# 
# boulder.p.sales[
#   (boulder.p.sales$count.musa>1) | 
#   (boulder.p.sales$count.apn>1),
# ] %>% st_drop_geometry()

boulder.p.sales %>% distinct(., id.musa)

```
## B Site Addresses

``` {r import_siteadds}
# https://opendata-bouldercounty.hub.arcgis.com/datasets/bouldercounty::address-points/about

# 'Site address points' refer to the location of a site or service delivery address assigned by a local government.

# SITE ADDRESS POINTS (?)
address_path =
  "./data/Boulder_AddressPts_20211009.geojson"
boulder.address = st_read(address_path) %>%
  st_transform(., col_crs)
```

## C Accessory Assessor Tables

### 1 Import 
``` {r import_accessory}

# https://www.bouldercounty.org/property-and-land/assessor/data-download/

# METADATA
## 'parcel' refers to a unique piece of land
### "PARCELNO" field is the tax parcel number

## 'property' refers to the land and building
### individual 'account' for each land & building
### “strap” field is the tax account number
#### Real property accounts start with “R”
#### mobile home accounts start with “M”

## one-to-many relationships between parcels & accounts
### could be differing owned of land/property

## buildings are structures with an account


# Owners & Addresses
owner_path =
  "./data/Owner_Address.csv"
boulder.p.owner.raw = read.csv(owner_path) %>%
  rename(
    id.apn  = folio,
    id.acct = strap
    )%>%
  filter(
    role_cd=='P' &
    account_type != 'MANUFACTURED HOME' & 
    account_type != 'MINERALS'
    ) %>%
  mutate(
    address = paste(
      str_num,
      str,
      str_pfx,
      str_sfx,
      str_unit,
      city,
      "Colorado"
    )
  ) %>% 
  select(-owner_name)

#boulder.p.owner.raw[boulder.p.owner.raw$id.apn == '157508Q01001',]
boulder.p.owner.raw[boulder.p.owner.raw$id.acct == 'R0614549','address'] = "537 LA FARGE  AVE  LOUISVILLE Colorado"

sales.add.in = boulder.sales[boulder.sales$address %in% boulder.p.owner.raw$address,]$address

boulder.p.owner = 
  boulder.p.owner.raw[
    (boulder.p.owner.raw$address %in% sales.add.in),
    c('id.acct', 'id.apn', 'address', 'bld_num', 'nh', 'account_type')] %>%
  distinct() %>%
  mutate_by(
    group=address,
    count.add=n()
  ) %>%
  mutate_by(
    group=id.apn,
    count.apn = n()
  )

# Account & Parcel Numbers (?)
acct_path =
  "./data/Account_Parcels.csv"
boulder.p.acct = 
  read.csv(acct_path) %>%
  rename(
    id.apn  = Parcelno,
    id.acct = strap
    )


# Buildings 
build_path =
  "./data/Buildings.csv"
boulder.p.build = read.csv(build_path) %>%
  rename(id.acct = strap)

boulder.p.build %>%
  filter(id.acct %in% boulder.sales$id.acct)
  

# Land
land_path =
  "./data/Land.csv"
boulder.p.land = read.csv(land_path)

## PERMIT RECORDS
# permits =
#   "./data/Permits.csv"
# B.build = read.csv(build_path)

###################

# boulder.p.acct %>% 
#   filter(id.apn %in% )

```



### 2 Narrow Down Account Table

``` {r Combine}

own.add.dupe = boulder.p.owner[boulder.p.owner$count.add>1,] %>% unique()
own.add.dupe = own.add.dupe$address

########

filter.add_in_sales = (boulder.p.owner$address %in% sales.add.in)
filter.dup_add      = (boulder.p.owner$address %in% own.add.dupe)

boulder.p.owner.good = 
  boulder.p.owner[filter.add_in_sales&!filter.dup_add,]
print(nrow(boulder.p.owner.good))

boulder.p.owner.bad = 
  boulder.p.owner[filter.add_in_sales&filter.dup_add,]

count_unique(boulder.p.owner.bad$address)

subtable_non_res = function(df) df %>% filter(grepl("RESIDENTIAL",account_type))

boulder.p.owner.bad_split = 
  boulder.p.owner.bad %>% 
  arrange(address) %>%
  split(., .[['address']]) %>%
  lapply(., subtable_non_res) %>%
  do.call("rbind", .) %>%
  # find those still having address duplicates
  mutate_by(group=address, count.add2=n()) %>%
  arrange(desc(count.add2))

adds.first_correct_add_dup    = boulder.p.owner.bad_split[boulder.p.owner.bad_split$count.add2==1,]$address
filter.first_correct_add_dup  = (boulder.p.owner$address %in% adds.first_correct_add_dup)
boulder.p.owner.first_dupe    = boulder.p.owner[filter.first_correct_add_dup,]
print(length(adds.first_correct_add_dup))

filter_two_column = function(compare_df, focus_df, first_col, second_col){
    apply(
      compare_df[,c(first_col,second_col)],
      1,
      function(first_row){
        focus_df[
          (focus_df[first_col]==first_row[1])&
          (focus_df[second_col]==first_row[2]),]}
    ) %>%
    do.call("rbind", .)}

boulder.p.owner.second_dupe = 
  filter_two_column(
    boulder.p.owner.bad_split[boulder.p.owner.bad_split$count.add2>1,],
    boulder.p.sales,
    'id.apn','address'
  ) %>%
  na.omit() %>%
  select(id.apn, address) %>%
  filter_two_column(
    .,
    boulder.p.owner,
    'id.apn','address'
  )
print(nrow(boulder.p.owner.second_dupe))

boulder.p.owner.add = 
  rbind(
    boulder.p.owner.good,
    boulder.p.owner.first_dupe,
    boulder.p.owner.second_dupe
  ) %>%
  select(-count.add,-count.apn) %>%
  mutate_by(
    group=address,
    count.add=n()
  ) %>%
  mutate_by(
    group=id.apn,
    count.apn = n()
  ) %>% 
  arrange(desc(count.apn), desc(count.add))


boulder.p.owner.good_join = 
  boulder.p.owner.add[
    (boulder.p.owner.add$count.add==1) &
    (boulder.p.owner.add$count.apn==1),]

boulder.p.owner.good_join = 
  merge(
    boulder.p.owner.good_join %>%
      select(id.acct, id.apn, address),
    boulder.sales %>% 
      select(address, id.musa),
    on='address'
  )

print(nrow(boulder.p.owner.good_join))

boulder.sales.not_in = 
  boulder.sales %>%
  filter(!address %in% boulder.p.owner.good_join$address)

boulder.p.sales.remain = 
  boulder.p.sales %>% 
    filter(id.apn %in% boulder.p.owner.raw$id.apn) %>%
    filter(id.musa %in% boulder.sales.not_in$id.musa) %>%
    mutate_by(
      group=id.apn,
      count.apn = n()
    ) %>%
    mutate_by(
      group=id.musa,
      count.musa = n()
    ) %>%
    mutate_by(
      group=address,
      count.add = n()
    ) %>%
    arrange(desc(count.musa), desc(count.apn), desc(count.add))

boulder.p.build.resi = 
  boulder.p.build %>% 
  filter(substr(designCode,1,1)=='0')

boulder.p.sales_fix = 
  boulder.p.acct %>% 
  filter(
    (id.apn %in% boulder.p.sales.remain$id.apn)
    ) %>%
  mutate_by(group=id.apn,count.apn=n()) %>%
  arrange(count.apn)

boulder.p.sales.first_fix =
  rbind(
    boulder.p.sales_fix[boulder.p.sales_fix$count.apn==1,],
    boulder.p.sales_fix[boulder.p.sales_fix$count.apn>1,] %>%
      filter(
        (id.acct %in% boulder.p.build.resi$id.acct) &
        (substr(id.acct,1,1)!='M'))
    ) %>%
  merge(
    .,
    boulder.p.sales.remain %>%
      filter(id.apn %in% boulder.p.sales_fix$id.apn) %>% 
      select(id.musa,id.apn,address),
    on='id.apn'
  )

boulder.p.sales.second_fix = 
  boulder.p.sales %>% 
  filter(
    (!id.musa %in% boulder.p.sales.first_fix$id.musa) & 
    (id.musa %in% boulder.sales.not_in$id.musa)) %>% 
  merge(., boulder.p.acct, on='id.apn')

length(unique(boulder.sales$id.musa))
nrow(boulder.p.owner.good_join) + nrow(boulder.p.sales.first_fix) + nrow(boulder.p.sales.second_fix)
length(unique(c(
  boulder.p.owner.good_join$id.acct, 
  boulder.p.sales.first_fix$id.acct,
  boulder.p.sales.second_fix$id.acct
  )))

boulder.p.sales.join =
  rbind(
    boulder.p.owner.good_join %>% 
      select(id.musa, address, id.apn, id.acct),
    boulder.p.sales.first_fix %>% 
      select(id.musa, address, id.apn, id.acct),
    boulder.p.sales.second_fix %>% 
      select(id.musa, address, id.apn, id.acct)
  )


# boulder.p.build.join =
#   boulder.p.build %>% 
#   filter(
#     (id.acct %in% boulder.p.sales.join$id.acct) & 
#     (bldgClass==1212) &
#     (designCode,1,1)=='0')) %>%
#   mutate_by(group=id.acct, count.acct = n()) %>% 
#   #distinct(id.acct, designCode) %>%
#   arrange(desc(count.acct))
# 
# boulder.p.build.join = 
#   boulder.p.build.join[ !duplicated(boulder.p.build.join[, c("id.acct")]),]


boulder.p.build %>% 
  filter(id.acct %in% boulder.p.sales.join$id.acct) %>%
  mutate_by(group=id.acct,count.acct = n()) %>%
  arrange(count.acct) %>%
  group_by(count.acct) %>% summarize(count = n())

boulder.p.build %>% filter(boulder.p.build$id.acct %in% boulder.p.sales.join$id.acct) %>%
  arrange(bldgClass) %>% mutate_by(group=bldgClass,count.class = n()) %>% select(bldgClassDscr,count.class) %>% unique()

resi_codes = 
  c('SINGLE FAM RES IMPROVEMENTS', 'DUP/TRIPLEX IMPROVEMENTS', 'MULTI-UNITS (4-8) IMPROVEMENTS', 'MULTI-UNITS (9+) IMPROVEMENTS', 'CONDOS-IMPROVEMENTS', 'MANUFACTURED HOUSING IMPROVEMENTS', 'MANUFACTURED HOME PARK IMPROVEMENTS')

#buildcols = colnames(boulder.p.build)
#buildcols[!buildcols %in% colnames(boulder.sales)]

```

## D Combine

``` {r combine}


boulder.p.count_dupes =
  boulder.parcel %>%
  select(id.apn) %>% 
  st_drop_geometry() %>%
  mutate(
    in.sales = ifelse(
      id.apn %in% boulder.p.sales.join$id.apn,
      1, 0)) %>%
  group_by(id.apn, in.sales) %>%
  summarize(
    count.apn = n()) %>%
  arrange(desc(in.sales),desc(count.apn))

boulder.p.dupes.sales = 
  boulder.p.count_dupes %>% 
  filter((in.sales==1)&(count.apn>1)) %>%
  pull(id.apn)

boulder.p.dupes.other = 
  boulder.p.count_dupes %>% 
  filter((in.sales==0)&(count.apn>1)) %>%
  pull(id.apn)

boulder.parcel.rejoin =
  boulder.parcel %>%
  filter(id.apn %in% c(boulder.p.dupes.sales, boulder.p.dupes.other)) %>%
  group_by(id.apn) %>%
  summarize(
    geometry = st_union(geometry),
    lot.sqft = st_area(geometry) %>%
      as.numeric()) %>% 
  st_as_sf()

parcel_save = 
  rbind(
    boulder.parcel.rejoin %>% 
      select(id.apn,lot.sqft,geometry),
    boulder.parcel %>% 
      filter(!id.apn %in% boulder.parcel.rejoin$id.apn) %>%
      select(id.apn,lot.sqft,geometry)
  ) %>%
  st_transform(st_crs('EPSG:4326'))

st_write(parcel_save, "data/Boulder_Parcels_20211009_fix.geojson", delete_dsn = TRUE)
  
parcel_test = st_read("data/Boulder_Parcels_20211009_fix.geojson")

boulder.p.sales.join 

write.csv(boulder.p.sales.join, file = "data/Boulder_Sales_Assessor_join.csv")

```

### E sales/parcels land 
``` {r write}
boulder.p.land = boulder.p.land %>% rename(id.acct = strap)
join_id = boulder.p.land[boulder.p.land$lot.sqft>0,] %>% pull(id.acct)

boulder.land.join = 
  boulder.p.sales %>% 
      filter(id.acct %in% join_id) %>%
      select(-lot.sqft) %>%
  # merge(
  #   boulder.p.sales %>% 
  #     filter(id.acct %in% join_id) %>%
  #     select(-lot.sqft),
  #   boulder.p.land[
  #     !duplicated(boulder.p.land$id.acct) & 
  #     (boulder.p.land$id.acct %in% boulder.p.sales$id.acct), ] %>%
  #     select(id.acct, lot.sqft),
  #   on = 'id.acct'
  # ) %>%
  rbind(
    .,
    boulder.p.sales %>% 
      filter(!id.acct %in% join_id)
  ) %>%
  st_drop_geometry() %>%
  select(id.musa, address, id.apn, id.acct, lot.sqft)


write.csv(boulder.land.join, file = "data/Boulder_Sales_Assessor_join.csv")


join.tax = read.csv("data/Boulder_Sales_Assessor_join.csv")

join.tax %>%
  merge(
    .,
    boulder.parcel,
    on = 'id.apn',
      
  )

land.fix = 
  boulder.p.land %>%
    mutate(
      GIS_sqft = ifelse(
        landUnitType=='SF',
        GIS_sqft,
        ifelse(
          landUnitType=='AC',
          GIS_sqft * 43560,
          0
        )
      )
    )

boulder.p.land %>% group_by(landUnitType) %>% summarize(count=n())

```

# 3 Parcel Clean

```{r parcel_clean}

# OG_len = nrow(boulder.parcel%>% st_drop_geometry())
# APN_len = nrow(boulder.parcel %>% st_drop_geometry() %>% distinct(., APN))
# ID_len = nrow(boulder.parcel %>% st_drop_geometry() %>% distinct(., ID, APN))
# area_len = nrow(boulder.parcel[boulder.parcel$area>0,] %>% st_drop_geometry() )
# 
# print(OG_len)
# print(OG_len-APN_len)
# print(OG_len-ID_len)
# print(OG_len-area_len)
# 
# # boulder.parcel[(boulder.parcel$area<=0)&(boulder.parcel$APN %in% dupe_APN),]
# 
# n_occur =
#   data.frame(table(boulder.parcel$APN)) %>%
#   rename(APN=Var1) %>% arrange(-Freq)
# 
# dupe_APN = n_occur[n_occur$Freq > 1,"APN"]
# B.dupe =
#   boulder.parcel[boulder.parcel$APN %in% dupe_APN,] %>% group_by(APN) %>%
#   summarize(geometry = st_union(geometry))
# 
# boulder.parcel[(boulder.parcel$APN == "157505036006")&
#         (boulder.parcel$area>0),]
# 
# boulder.county = boulder.parcel %>% st_union(.)
# 
# ggplot() +
#   geom_sf(data=boulder.county, lwd=.1, color='lightgrey')
# +
#   geom_sf(data=boulder.parcel, lwd=.1) +
#   geom_sf(data=B.dupe,
#           fill='pink', color='red') +
#   plot_limits(data= B.dupe)
```


## 4 City & County boundaries 

```{r bound}

# CREATE ERASE FUNCTION
st_erase = function(x, y) {
  st_difference(x, st_union(y))}

state.cities = 
  st_read('data/col_city_boundaries.geojson') %>%
  st_transform(., col_crs) %>%
  rename(
    name = NAME10,
    name_long = NAMELSAD10
  ) %>% 
  mutate(incorporated = 
          ifelse(grepl('city', name_long), 'city',
                 ifelse(grepl('town', name_long), 'town',
                        ifelse(grepl('CDP', name_long), 'CDP',
                               'TRUE'))))
state.counties = 
  st_read('data/col_county_boundaries.geojson') %>%
  st_transform(., col_crs)

state.bound = 
  st_read('data/col_state_boundary.geojson') %>%
  st_transform(., col_crs)

state.cities = 
  state.counties %>% select(LABEL, FULL, geometry) %>%
      rename(name = LABEL, name_long = FULL) %>% 
      mutate(
        name_long = paste('Unincorporated', name_long, sep=" "),
        name = paste(name, 'County', sep=" "),
        incorporated = 'County'
        ) %>%
  st_erase(.,
    state.cities) %>% select(name, name_long, incorporated, geometry) %>%
  rbind(
    .,
    state.cities %>% select(name, name_long, incorporated, geometry)) %>%
  st_sf() %>%
  mutate(first_area = st_area(geometry))

attributes(state.cities$first_area) = NULL

boulder.county = state.counties %>% filter(COUNTY=="BOULDER")
boulder.cities = 
  st_intersection(
    state.cities, 
    boulder.county %>% st_union(.)) %>%
  mutate(land_area = st_area(geometry)) %>%
  filter((incorporated!='County')|grepl('Boulder', name_long))

attributes(boulder.cities$land_area) = NULL

boulder.cities = 
  boulder.cities %>%
  mutate(pct_bould = land_area/first_area) %>%
  filter(pct_bould>=0.1) %>% select(-pct_bould)



boulder.cities.labels = 
  boulder.cities %>%
  st_centroid(., of_largest_polygon = TRUE) %>% 
  filter((incorporated!='County')) %>%
  mutate(
    lon = map_dbl(geometry, 
                  ~st_centroid(.x, of_largest_polygon = TRUE)[[1]]),
    lat = map_dbl(geometry, 
                  ~st_centroid(.x, of_largest_polygon = TRUE)[[2]]),
    size = 
          ifelse(grepl('city', name_long), 2,
                 ifelse(grepl('town', name_long), 1.5,
                        ifelse(grepl('CDP', name_long), 0,
                               0)))) %>% 
  filter(size>0)



boulder.cities[
  st_is(boulder.cities$geometry, 'GEOMETRYCOLLECTION'), 
  'geometry'] = 
  boulder.cities[
    st_is(boulder.cities$geometry, 'GEOMETRYCOLLECTION'), 
    'geometry'] %>%
    st_make_valid(.) %>% 
    st_buffer(1) %>%
    st_union(., by_feature=TRUE) %>%
    st_buffer(-1)

bc.buff = boulder.cities %>% st_union() %>% st_buffer(mile * 2)
boulder.cities.nearby = st_intersection(state.cities, bc.buff) %>% filter(incorporated != 'County')

col.cities.list = state.cities %>% st_drop_geometry() %>% filter(incorporated != 'County')
col.cities.list = col.cities.list$name %>% unique() %>% toupper()
boulder.cities.list = boulder.cities.nearby$name %>% unique() %>% toupper()


###################


```

## 5 Neighborhoods
### A Import
``` {r neighborhoods}

boulder.nhoods = 
  st_read('data/boulder_precincts.geojson') %>%
  st_transform(col_crs) %>% 
  select(ABBREVIATI) %>% rename(nhood_id = ABBREVIATI) %>%
  mutate(
    nhood_id = nhood_id %>% as.character(.),
    neighborhood = nhood_id)

```

### B City Join

``` {r city}

st_true_union = function(a,b) {
   st_agr(a) = "constant"
   st_agr(b) = "constant"
   op1 = st_difference(a, st_union(b))
   op2 = st_difference(b, st_union(a))
   op3 = st_intersection(b, a)
   union = plyr::rbind.fill(op1, op2, op3)
   return(st_as_sf(union))
}


get_majority_intersect = 
  function(focus_sf, focus_id_field, compare_sf, compare_id_field,
           # rename_compare_id_field='',
           minimium_area_pct = .25){
    focus_crs = st_crs(focus_sf)
    
    sf.focus = 
      focus_sf %>%
      select(focus_id_field)
    
    sf.compare = 
      compare_sf %>%
      select(compare_id_field) %>%
      st_transform(focus_crs)
    
    sf.focus_compare = 
      st_true_union(
        sf.focus %>% 
          mutate(focus_area = st_area(geometry)),
        sf.compare %>% 
          select(compare_id_field) %>%
          mutate(compare_area = st_area(geometry))
        )
    
    sf.focus_compare = 
      sf.focus_compare %>% 
      filter(
        !is.na(sf.focus_compare[[compare_id_field]]) & 
          !is.na(sf.focus_compare[[focus_id_field]])) %>%
      group_by_at(vars(c(focus_id_field, compare_id_field))) %>%
      summarize(
        geometry = st_union(geometry),
        focus_area = mean(focus_area),
        compare_area = mean(compare_area)
        ) %>%
      mutate(
        #union_id = seq.int(nrow(.)) %>% as.character(.),
        union_area = st_area(geometry)
      )
    
    attributes(sf.focus_compare$focus_area) = NULL
    attributes(sf.focus_compare$compare_area) = NULL
    attributes(sf.focus_compare$union_area) = NULL
    
    sf.focus_compare$compare_pct = 
      sf.focus_compare$union_area/sf.focus_compare$focus_area
    
    sf.focus_compare = 
      sf.focus_compare %>% 
      filter(compare_pct > minimium_area_pct) %>%
      group_by_at(vars(focus_id_field)) %>% 
      slice(which.max(compare_pct))
    
    
    # if(rename_compare_id_field!=''){
    #   
    #   col_names = colnames(sf.focus_compare)
    #   
    #   old = c(compare_id_field)
    #   all_old = all_of(c(col_names[!col_names %in% old], old))
    #   new = c(rename_compare_id_field)
    #   all_new = all_of(c(col_names[!col_names %in% new], new))
    #   print(sf.focus_compare)
    #   sf.focus_compare = 
    #     sf.focus_compare %>% 
    #     plyr::rename(., c(compare_id_field=rename_compare_id_field))
    #     # select(all_old) %>%
    #     # rename_with(~ all_new, all_old)
    #   
    #   compare_id_field = rename_compare_id_field
    # }
    
    sf.focus = 
      focus_sf %>%
      merge(
        .,
        sf.focus_compare %>%
          select(focus_id_field, compare_id_field) %>% st_drop_geometry(.),
        on=focus_id_field,
        all.x = TRUE
      )
    
    print('number of null joins')
    print(nrow(sf.focus[is.na(sf.focus[[compare_id_field]]),]))
    
    sf.focus[[compare_id_field]][is.na(sf.focus[[compare_id_field]])] = 'NULL'
    
    return(sf.focus)
  }

boulder.nhoods.c =
  get_majority_intersect(
    boulder.nhoods, 'nhood_id', 
    boulder.cities, 'name',
    # rename_compare_id_field = 'region',
    minimium_area_pct=.1)

boulder.nhoods.c =
  boulder.nhoods.c %>%
  merge(
    .,
    boulder.nhoods.c %>%
      group_by(name) %>%
      summarise(name_count = n()) %>%
      st_drop_geometry(.),
    on='name'
        ) %>%
  rename(
    city = name,
    city_count = name_count
  )
  
###########

```

### C Zillow Join 

``` {r Zillow}
library(rgdal)

# The input file geodatabase
fgdb = "data/Zillow_Neighborhoods/ZillowNeighborhoods.gdb"

# List all feature classes in a file geodatabase
subset(ogrDrivers(), grepl("GDB", name))
fc_list = ogrListLayers(fgdb)
print(fc_list)

# Read the feature class
boulder.nhoods.z =
  readOGR(dsn=fgdb,layer="ZillowNeighborhoodsAreas") %>%
  st_as_sf(.)

boulder.nhoods.z =  
  boulder.nhoods.z %>%
  filter(
    boulder.nhoods.z$State=='CO') %>%
  st_transform(col_crs) %>%
  rename(
    zhood = Name,
    zhood_id = RegionID
  ) %>%
  select(zhood, zhood_id)

boulder.nhoods.cz =
  get_majority_intersect(
    boulder.nhoods.c, 'nhood_id', 
    boulder.nhoods.z, 'zhood_id',
    # rename_compare_id_field = 'region',
    minimium_area_pct=.1)

boulder.nhoods.cz =
  boulder.nhoods.cz %>%
  merge(
    .,
    boulder.nhoods.z %>%
      select(zhood_id, zhood) %>%
      st_drop_geometry(.),
    on=zhood_id,
    all.x = TRUE) %>%
  mutate_by(
    ., 
    group=zhood_id, 
    zhood_count = n()
    )

boulder.nhoods.cz[boulder.nhoods.cz$zhood_id=='NULL', 'zhood_count']=0

boulder.nhoods.cz %>% 
  group_by(zhood_id) %>% 
  summarize(count = mean(zhood_count),
            first = first(zhood)) %>% 
  st_drop_geometry() %>%
  arrange(count)


boulder.nhoods.cz =
  boulder.nhoods.cz %>%
  mutate(
    name = ifelse(
      zhood_id=='NULL', 
      city,
      zhood
    )) %>%
  mutate_by(
    group=name, 
    name_count = n(),
    neighborhood = ifelse(
      name_count > 1,
      paste(name, row_number()),
      name)
    )
      
boulder.nhoods.cz %>% arrange(-name_count)

```

### D Orientation Join

``` {r orient}

boulder.nhoods.focus.group =
  boulder.nhoods.cz %>%
    filter(boulder.nhoods.cz$name_count>1) %>%
  mutate_by(
    group=name,
    group.geometry = st_union(geometry),
    group.centroid = st_centroid(group.geometry),
    group.area = st_area(group.geometry),
    nhood.geometry = geometry
    ) %>%
  mutate(nhood.area = st_area(geometry))

attributes(boulder.nhoods.focus.group$group.area) = NULL
attributes(boulder.nhoods.focus.group$nhood.area) = NULL


## function to create orientation sector sf (NESW) (NE,SE,SW,NW) (Center)
get_max_yx_lengths = function(sf_focus){
  f_coords = 
    sf_focus %>% 
      st_union(.) %>%
      st_centroid(.) %>%
      st_coordinates(.)

  x = f_coords[1]
  y = f_coords[2]
  
  f_box = sf_focus %>% st_bbox(.)
  
  y_length = max(f_box$ymax-y, y-f_box$ymin)
  x_length = max(f_box$xmax-x, x-f_box$xmin)
  
  xy_list = list()
  
  xy_list['ymax'] = y_length
  xy_list['xmax'] = x_length
  return(xy_list)
}

st_envelope = function(sf_focus){
  xy_list = get_max_yx_lengths(sf_focus)

  box = sf_focus %>% 
        c(diff(st_bbox(.)[c(1, 3)]), diff(st_bbox(.)[c(2, 4)]))
  buff_size = max(box$ymax, box$xmax)
  
  bbox_wrap = function(x) st_as_sfc(st_bbox(x))
  
  sf.focus
    sf_focus %>%
    st_union(.) %>%
    st_centroid(.) %>%
    st_buffer(., buff_size) %>%
    st_sf(.) %>%
    mutate(bbox = map(geometry, bbox_wrap),
           geometry = st_as_sfc(do.call(rbind, bbox))) %>%
    select(-bbox) 
    
  return(sf.focus)
}
  
sf_rotated_fish = function(sf_focus, rotate_angle=45){
  #focus_crs = st_crs(3857)
  focus_crs = st_crs(sf_focus)
  
  sf.focus = sf_focus %>% 
    st_transform(., focus_crs) %>% 
    st_union(.) %>%
    st_geometry(.)
  
  
  xy_list = get_max_yx_lengths(sf.focus)

  box = sf_focus %>% 
        st_transform(., focus_crs)  %>%
        c(diff(st_bbox(.)[c(1, 3)]), diff(st_bbox(.)[c(2, 4)]))
  buff_size = max(box$ymax, box$xmax)
  bbox_wrap = function(x) st_as_sfc(st_bbox(x))
  
  rot = function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)
  tran = function(geo, ang, center) (geo - center) * rot(ang * pi / 180) + center
  
  sf.input =
    sf.focus %>%
    st_sf(.) %>%
    st_union(.) %>%
    st_centroid(.) %>%
    st_buffer(., buff_size) %>%
    st_sf(.) %>%
    mutate(bbox = map(geometry, bbox_wrap),
           geometry = st_as_sfc(do.call(rbind, bbox))) %>%
    select(-bbox) %>%
    st_geometry(.)
  
  center = st_centroid(st_union(sf.input))
  sf.grid = st_make_grid(
    tran(sf.input, -rotate_angle, center), 
    square = TRUE,
    n = c(2,2),
    what='polygons'
    )
  sf.grid_rotate = 
    tran(sf.grid, rotate_angle, center) %>%
    st_sf(., crs=focus_crs) %>%
    st_transform(., st_crs(sf_focus))

return(sf.grid_rotate)
}

  

  
get_fish_name = function(
    focus_name,
    return_all=FALSE
                         ){
  
  boulder.nhoods.focus = boulder.nhoods.focus.group %>%
    filter(name == focus_name)
  
  bbox_wrap = function(x) st_as_sfc(st_bbox(x))
  xy_list = get_max_yx_lengths(boulder.nhoods.focus)
  
  boulder.nhoods.focus.fish = 
    rbind(
      sf_rotated_fish(
         boulder.nhoods.focus,
         rotate_angle=45) %>% 
        mutate(orientation = c('W','S','N','E')) %>%
        st_intersection(., boulder.nhoods.focus),
      
      st_make_grid(
        boulder.nhoods.focus %>% 
          st_union(.) %>%
          st_centroid(.) %>%
          st_buffer(., max(xy_list$ymax, xy_list$xmax)),
        square = TRUE,
        n = c(2,2),
        what='polygons') %>% 
      st_sf(.) %>%
      mutate(orientation = c('SW','SE','NW','NE')) %>%
      st_intersection(., boulder.nhoods.focus),
      
      boulder.nhoods.focus %>% 
        st_union(.) %>%
        st_centroid(.) %>%
        st_buffer(., max(xy_list$ymax, xy_list$xmax)*.35) %>% 
      st_sf(.) %>%
      mutate(orientation = c('Center')) %>%
      st_intersection(., boulder.nhoods.focus)
      ) %>%
    mutate(
      nhood.pct = nhood.area/group.area,
      orient.area = st_area(geometry)
    )
  attributes(boulder.nhoods.focus.fish$orient.area) = NULL
  
  boulder.nhoods.focus.fish.group = 
    boulder.nhoods.focus.fish %>%
    mutate(orient.pct = orient.area/nhood.area) %>%
    group_by(nhood_id) %>%
    slice(which.max(orient.pct)) %>%
    mutate(
      geometry = nhood.geometry,
      orient.name = ifelse(
        nhood.pct >= .6,
        name,
        paste(orientation, name))
      ) %>%
    st_drop_geometry(.) %>%
    select(nhood_id, orient.name, orientation)
  
  if(return_all==FALSE){
    return(
      boulder.nhoods.focus.fish.group 
      )
  } else{
    return(
      boulder.nhoods.focus.fish %>%
        mutate(orient.pct = orient.area/nhood.area)
      )
  }
  
}

boulder.nhoods.orient = 
  do.call(rbind.data.frame, 
        lapply(unique(boulder.nhoods.focus.group$name), get_fish_name)) %>%
  mutate_by(
      group=orient.name, 
      orient.count = n(),
      orient.name = ifelse(
        orient.count > 1,
        paste(orient.name, row_number()),
        orient.name)
      )
      
glimpse(boulder.nhoods.orient)


random_sample = 
  boulder.nhoods.focus.group$name[sample.int(length(boulder.nhoods.focus.group$name), 1)]

boulder.nhoods.focus.fish_all =
  get_fish_name(random_sample, return_all=TRUE)

boulder.nhoods.focus.fish = 
  boulder.nhoods.focus.fish_all %>%
    mutate(orient.pct = orient.area/nhood.area) %>%
    group_by(nhood_id) %>%
    slice(which.max(orient.pct)) %>%
    mutate(
      geometry = nhood.geometry,
      orient.name = ifelse(
        nhood.pct >= .6,
        name,
        paste(orientation, name))
      )

ggplot() + 
  geom_sf(
    data = 
      boulder.nhoods.focus.fish_all %>%
        group_by(orientation) %>%
        summarize(geometry=st_union(geometry)), 
    fill='transparent',
    color='grey50') + 
  geom_sf(
    data = 
      boulder.nhoods.focus.fish_all %>%
        mutate(orient.pct = orient.area/nhood.area) %>%
        group_by(nhood_id) %>%
        slice(),
    aes(fill=nhood_id), alpha=.5,
    color='black', linetype = "dashed") +
  geom_sf(
    data = 
      boulder.nhoods.focus.fish_all %>% 
        st_union(.) %>% st_centroid(.), 
    color='black') +
  # geom_sf(data = boulder.cities, fill = 'transparent', color='grey',
  #         lwd=.1, linetype = "dashed") + 
  # geom_sf(data = boulder.county, fill = 'transparent', color='black',
  #         lwd=1) + 
  geom_text_sf(sf_to_labels(
    boulder.nhoods.focus.fish_all %>% 
      group_by(orientation) %>%
      summarize(geometry = st_union(geometry)), 
    'orientation'), 
    color='grey50', 
    size=1) +
  geom_text_sf(sf_to_labels(
    boulder.nhoods.focus.fish %>%
      mutate(
        orient.name = 
          ifelse(neighborhood == 'University Hill 3',
                 'W University Hill',
                 orient.name)
      ), 
    'orient.name'), color='black') +
  theme(legend.position = "none") +  
  labs(title = "University Hill Voting Precincts") + 
  mapTheme() +
  plot_limits(data = boulder.nhoods.focus.fish$geometry)



#########

boulder.nhoods.czf = 
  boulder.nhoods.cz %>%
  merge(
    .,
    boulder.nhoods.orient %>% select(nhood_id, orient.name, orient.count),
    on = 'nhood_id',
    all.x = TRUE
  )
boulder.nhoods.czf$orient.count[is.na(boulder.nhoods.czf$orient.count)] = 0

boulder.nhoods.czf = 
  boulder.nhoods.czf %>% 
  select(-name_count) %>%
  mutate(
    name = ifelse(
      orient.count > 0,
      orient.name,
      ifelse(
        zhood_count == 1,
        zhood,
        city
      ))
  ) %>% 
  mutate_by(
    group=name,
    name_count = n(),
    neighborhood = ifelse(
      name_count > 1,
      paste(name, row_number()),
      name)
    ) %>%
  rename(sub_nhood = zhood) %>%
  select(
    nhood_id,
    city,
    neighborhood
  )

boulder.nhoods.czf
st_write(
  boulder.nhoods.czf, 
  "data/boulder_neighborhoods.geojson")

```

### E Combine NHood

``` {r add_nhood}

boulder.nhoods = boulder.nhoods.czf

boulder.sales =
  boulder.sales %>% 
  #select_if(!names(.) %in% c('neighborhood')) %>%
  st_join(., boulder.nhoods)

boulder.sales %>%
  group_by(neighborhood) %>%
  summarize(
    house_count = n()
    )

boulder.nhoods =
  boulder.nhoods %>%
  merge(
    .,
    aggregate(boulder.sales$MUSA_ID,
            by=list(boulder.sales$neighborhood), FUN=length) %>%
      rename(neighborhood = Group.1, house_count=x),
    by = 'neighborhood', all.x=TRUE) 

boulder.nhoods$house_count[is.na(boulder.nhoods$house_count)] = 0

second_max = function(vector){
  vector_mx = max(vector)
  vector_cut = 
  vector[
    vector<vector_mx]
  return(max(vector_cut))
}

hist(boulder.nhoods$house_count, breaks=50)

ggplot() + 
  # geom_sf(
  #   data = boulder.cities, 
  #   aes(fill=incorporated), 
  #   color='transparent') + 
  geom_sf(
    data = boulder.nhoods, 
    aes(fill=nhood_id), 
    color='grey50') + 
  geom_sf(data = boulder.cities, fill = 'transparent', color='grey',
          lwd=.1, linetype = "dashed") + 
  geom_sf(data = boulder.county, fill = 'transparent', color='black',
          lwd= 1) + 
  geom_text(
    data=boulder.cities.labels, check_overlap=TRUE,
    size = ifelse(boulder.cities.labels$size==2,2.5,2), 
    fontface='bold', color='black',
    aes(x=lon,y=lat, label=name)) + 
   theme(legend.position = "none") + 
  mapTheme()

```
## 6 Schools
### A Proto

```{r html}

library(rvest)

school.raw = 
  do.call(rbind, table) %>% as.data.frame(.) %>%
  mutate(
    id = id %>% gsub("zcsch", "sch", .),
    url = 
      glue('https://s3.amazonaws.com/gm-zdm/gj/sch/{id}.geojson'),
    name = name %>% 
      gsub("Display ", "", .) %>% 
      gsub("Attendance Zone Boundary", "", .),
    geometry = sapply(url, function(url){
       geom = st_read(url)
       return(geom[[2]] %>% as.vector())
      })
    ) %>%
  st_sf(., crs=st_crs('EPSG: 4326')) %>% 
  st_transform(col_crs)

st_write(school.raw, "data/boulder_school_boundary.geojson")

st_make_valid
school.raw


# school_geoms = 
#   c('https://s3.amazonaws.com/gm-zdm/gj/sch/sch_es_08_1570_2790.geojson',
#     'https://s3.amazonaws.com/gm-zdm/gj/sch/sch_es_08_0480_9544.geojson') %>%
#       sapply(., function(url){
#        geom = st_read(url)
#        return(geom[[2]] %>% as.vector())
#       })
# school_geoms 

as.vector(school_geoms) %>% st_sfc()

glimpse(col.districts.links)

```


### B get district links

```{r table}
library(rvest)

col.districts.links = 
  read_csv('data/col_district_links.csv') %>%
  mutate(
    district_type_id = 
      paste(
        district_id, 
        school_level %>% substr(., 1, 1),
        sep='_'
  ))

```

### C get school links

``` {r school}

get_table_attrs = function(dist.row){
  
  dist.row =
    map(dist.row, unlist)
  
  dist.url = dist.row$url
  
  dist.page = 
    read_html(dist.url)
  
  dist.table = 
    dist.page %>%
    html_nodes("[class='table table-striped table-bordered table-hover table-condensed']")
  
  ###
  
  dist.table.input =
    dist.table %>% 
    html_elements("input")
  
  dist.table.ids = 
    dist.table.input %>%
    html_attr('id') %>% 
    gsub('zcsch_','sch_', .) %>%
    data.frame(map_id = .)
    
  ###
  
  dist.table.text = 
    dist.table %>%
    html_nodes('tr')  %>%
    html_text2(.) %>% 
    as.vector(.)
  
  dist.table.name = 
    dist.table.text[1] %>% 
    gsub('List of ','', .)
  
  dist.table.columns = 
    dist.table.text[2] %>%
    strsplit(., "\t") %>%
    unlist(., recursive = TRUE, use.names = FALSE)
  
  table_to_farm = function(row_str){
    row_str = 
      row_str %>%
      gsub("[\n]",'',.)
    
    row_row = 
      row_str %>% 
      strsplit(., "[\t]") %>%
      unlist(., recursive = TRUE, use.names = FALSE)
    
    return(row_row[row_row!=""])
  }
  
  dist.table.list = 
    dist.table.text[3:length(dist.table.text)] %>%
    sapply(., FUN=table_to_farm)
  
  dist.table.list = 
    dist.table.list[lapply(dist.table.list, length) > 0]
  
  if (
     mean(sapply(dist.table.list, length)) != (length(dist.table.columns)-1)
   ){
     print('table_list_length')
     print(mean(sapply(dist.table.list, length)))
     print(dist.table.columns)
     
     
     bad = 
      dist.table.list[lapply(dist.table.list, length)<4] %>% names(.)
     print(dist.table.list[lapply(dist.table.list, length)<4])
     print(bad)
     
     for (idx in seq(length(bad))){
       bad_row = dist.table.list[lapply(dist.table.list, length)<4][[idx]]
       print(bad_row)
       sch_nm = bad_row[1]
       dist = bad_row[2]
       stu = bad_row[3]
       fix = c(sch_nm, dist, 'null', stu)
       
       print(fix)
       
       dist.table.list[lapply(dist.table.list, length)<4][[idx]] = fix
     }
   }
  
  dist.df = 
    dist.table.list %>%
    do.call(rbind.data.frame, .)
  
  if (
     mean(nrow(dist.df)) != (nrow(dist.table.ids))
   ){
     print('text table length')
     print(nrow(dist.df))
     print('id length')
     print(nrow(dist.table.ids))
  }
  
  dist.df = 
    cbind(dist.table.ids,dist.df)
  
  dist.table.columns = c(
    'map_id',
    'school_name_full',
    'dist_name_full',
    'school_city',
    'school_students'
  )
  colnames(dist.df) = dist.table.columns
  
  dist.df = 
    dist.df %>%
    mutate(
      dist_name = dist.row$name %>% tools::toTitleCase(.),
      school_level = dist.row$school_level %>% tools::toTitleCase(.),
      dist_id_full = dist.row$district_type_id,
      dist_id = dist.row$district_id,
      school_name = school_name_full %>% 
        gsub(glue('{school_level} School'), '', .) %>% trimws(.)
    )
  
  dist.columns = colnames(dist.df)
  dist.columns = c("map_id" ,dist.columns[2:length(dist.columns)] %>% sort(.))
  dist.df = dist.df[,dist.columns]
  
  return(dist.df)
}

col.districts.table = 
  col.districts.links %>%
  apply(., 1, get_table_attrs) %>%
  do.call(rbind.data.frame, .) %>%
  mutate(
    map_url = 
      glue('https://s3.amazonaws.com/gm-zdm/gj/sch/{map_id}.geojson'))
```

### D Districts

``` {r geom}

school.dist.scores = 
  read_csv('data/colorado_district_rankings_2021.csv') %>%
  mutate(
    GEOID = district_id %>% 
      sapply(., FUN = function(id){
        paste('08', gsub("\"", "", id), sep='')}), 
    district_id = district_id %>% 
      sapply(., FUN = function(id){gsub("\"", "", id)})) 


boulder.dist.ele = 
  col.dist.polys %>% 
  filter(school_level == 'Elementary')

geom_funct = function(url, map_id){
      geom =
      tryCatch(
        {
            st_read(url)$geometry
        },
        error = function(e){
            ''
        })
      # print(geom)
      # if(length(geom)>1){print(map_id)}
      return(geom)
      }

#geom_funct(col.districts.table$map_url, col.districts.table$map_id)
# col.districts.geoms = 
#   col.districts.table %>%
#   mutate(
#     geometry = 
#       tryCatch(
#         st_make_valid(st_read(map_url, quiet=TRUE)$geometry), 
#         error = function(e) { c(e) })
#   ) %>%
#   st_sf(., crs=st_crs('EPSG: 4326')) %>%
#   st_transform(col_crs)
# col.districts.geoms$geometry

geom_list = list()
bad_list = list()
for (url in col.districts.table$map_url){

  geom_list[[url]] =
    tryCatch(st_make_valid(st_read(url, quiet=TRUE)$geometry) %>% st_union(.), 
             error = function(e) { cat('In error handler\n'); print(e); e })
  
}

check = 
  geom_list %>% map_df(as_tibble)

check$map_url = names(geom_list) %>% as.vector()

col.districts.geom = 
  col.districts.table %>% 
  merge(., check, on='map_url') %>%
  st_sf(., crs=st_crs('EPSG: 4326')) %>%
  st_transform(col_crs)

st_write(col.districts.geom, "col_school_boundary.geojson")


boulder.dist.cach = 
  col.districts.geom %>%
  st_transform(col_crs) %>% mutate(pre_area = st_area(geometry)) %>%
  st_intersection(., boulder.county %>% st_union()) %>%
  mutate(post_area = st_area(geometry))

attributes(boulder.dist.cach$pre_area) = NULL
attributes(boulder.dist.cach$post_area) = NULL

boulder.ele.cach = 
  boulder.dist.cach %>% 
  mutate(pct_area = post_area/ pre_area) %>%
  filter(pct_area>0.01) %>%
  filter(.[['school_level']]=='Elementary') %>%
  select(map_id, dist_id, school_name, school_students)

```


### E School Location Points

``` {r Points}

col.school.pts = 
  st_read('data/col_elementary_points.geojson') %>%
  st_transform(col_crs) %>%
  #st_filter(., boulder.county %>% st_union()) %>%
  drop_na(.) %>%
  filter(
    #!(Highest_Grade %in% c("10th grade","10th Grade","11th grade","11th Grade","12th grade","12th Grade", "9th grade", "9th Grade" )) &
    Type_ != "Public School District Office Physical Address"
  )

unique(col.school.pts$Type_) %>% sort()

# library(stringdist)
# 
# dist_rank = 
#   stringdistmatrix(
#     col.school.rank$school,
#     col.school.pts$School_Name
#   )
# boulder.sales %>% 
#   merge(
#     ., 
#   )
  
#lapply(col.school.rank$school, function(rank_str) amatch(rank_str, col.school.pts$School_Name))

col.school.pts$School_Coded = paste("x", col.school.pts$School_Code %>% str_pad(., 4, pad = "0"), sep='')

```
### F School Rankings

``` {r ranks}
#########################################
library(hereR)

col.school.rank =
  read_csv('data/colorado_elementary_rankings_2020.csv') %>%
  rename(full_school_id = school_id) %>%
  mutate(
    full_school_id = full_school_id %>% 
      sapply(., FUN = function(id){gsub("\"", "", id)}),
    district_id = full_school_id %>% 
      sapply(., FUN = function(id){substr(id, 1, 4)}),
    school_id = full_school_id %>% 
      sapply(., FUN = function(id){substr(id, 7, 10)}),
    address_full =
      glue("{address}, {city}, Colorado, United States")
    ) %>% as.data.frame(.) %>% 
  rename(Address = address)

set_key("fujtkDNNxADOCxksuaWRUrRG6B5zGRZWRDT_2BZ2vek")
ele_rank_geom = geocode(col.school.rank$address_full)
glimpse(ele_rank_geom)

col.school.rank$geometry = ele_rank_geom$geometry
col.school.rank = col.school.rank %>% st_sf(.) %>% st_set_crs(col_crs)
col.school.rank$geocode.add = ele_rank_geom$address

col.school.rank %>% 
  mutate_by(
    ., 
    group=school,
    add_count = n()
    ) %>% 
  filter(add_count>1) %>%
  arrange(desc(add_count))

```
### G Add - Ranks to Locations

#### 1 sub sort by sep function
``` {r sorter}

get_sep_df = function(
  sep_vector_raw,
  sep = '.',
  sep_length = 2
){
  # Set Up Name DF
  sep_find = glue('\\{sep}')
  
  sep_vector_fix = sep_vector_raw
  sep_vector_fix[(sep %in% sep_vector_fix)]
  sep_in_str = sapply(sep_vector_fix, function(col) grepl(sep, col, fixed = TRUE))
  sep_vector_fix[!sep_in_str] = sep_vector_fix[!sep_in_str] %>% paste(., sep, ' ', sep='')
  
  cols_split_df = 
    str_split(sep_vector_fix, 
              sep_find, 
              # this stops the separating at the number of order
              # even if there is more periods
              n=sep_length) %>% 
      unlist(.) %>% 
      matrix(., ncol=sep_length, byrow=TRUE) %>%
    cbind(
      sep_vector_fix, 
      .) %>% 
      as_tibble(.)
  
  order_str = 
    paste(
      's',
      seq(from=1, to=sep_length, by=1),
      sep='')
  
  colnames(cols_split_df) = c('col', order_str)
  
  cols_split_df$col = sep_vector_raw
  
  return(
    cols_split_df
  )
}
  
sort_by_sep = function(
  sep_vector_raw,
  sep   = '.',
  order = c(1,2),
  rev   = c('',''),
  length = 0
){

  order_length = length(order)
  if (length>0){
    order_length = length
  }
  
  sep_df = get_sep_df(sep_vector_raw, sep=sep, sep_length = order_length)
  
  order_str = 
    paste(
      's',
      seq(from=1, to=order_length, by=1),
      sep='')
  
  sort_cols = sapply(order, function(i) order_str[i])
  
  for (i in seq_along(rev)){
    rev_item   = rev[i]
    sort_item  = sort_cols[1]
    if (rev_item!=''){
      sort_cols[i] = paste0("desc(", sort_item, ")")
    }}
  
  sep_df =
    sep_df %>%
    arrange_(
      .dots  = sort_cols
      )

  return(sep_df$col)
}

```

#### 2 compare strings
``` {r add_ranks}

library(stringdist)

function()

str_match_vec = function(add_str, comp_adds = col.school.pts$Address){
      focus_str_comps = stringdist(
        add_str %>% toupper(),
        comp_adds %>% toupper()
        )
      n_char_add = nchar(add_str)
      focus_str_comps = sapply(
        focus_str_comps, 
        function(str) 100-(str/n_char_add*100))
      max_num = max(focus_str_comps)
      max_idx = c(which(focus_str_comps == max_num))[1]
      max_add = comp_adds[max_idx]
      #return(max_idx)
      return(c(add_str, max_add, max_num))
    }

str_match_vec("8970 York Street")
str_match_vec(col.school.rank$Address[1])

ranks_to_add_comp = 
  lapply(
    col.school.rank$Address,
    str_match_vec
    ) %>% 
  unname() %>% unlist() %>% 
  matrix(., ncol = 3, byrow=T) %>% 
  data.frame()
colnames(ranks_to_add_comp) = c("Rank.Add", "Pts.Add", "Pct.Add")

ranks_to_add_comp = 
  ranks_to_add_comp %>%
  mutate(
    Pct.Add = Pct.Add %>% 
      as.numeric() %>% 
      round(2)
  ) %>%
  arrange(Pct.Add)

ranks_to_add_comp = 
  ranks_to_add_comp %>%
  merge(
    .,
    col.school.pts %>%
      rename(
        Pts.Add   = Address,
        #Pts.City   = City, 
        Pts.Name  = School_Name
      ) %>%
      select(
        Pts.Add, 
        #Pts.City, 
        Pts.Name) %>%
      st_drop_geometry(),
    on = 'Pts.Add',
    all.x = TRUE
  ) %>%
  merge(
    .,
    col.school.rank %>%
      rename(
        Rank.Add    = Address,
        Rank.City   = city, 
        Rank.Name   = school
      ) %>%
      select(
        Rank.Add, 
        Rank.City, 
        Rank.Name) %>%
      st_drop_geometry(),
    on = 'Rank.Add',
    all.x = TRUE
  ) %>% 
  unique()

comp_sorted = sort_by_sep(colnames(ranks_to_add_comp), sep='.', order=c(1,2), rev=c('',''))
ranks_to_add_comp = ranks_to_add_comp[, comp_sorted] %>% arrange(Pct.Add)

ranks_to_add_comp = 
  ranks_to_add_comp %>% 
  mutate_by(
    ., 
    group=Rank.Add,
    add_count = n()
    ) %>% 
  #filter(add_count>1) %>%
  arrange(desc(add_count))

ranks_to_add_comp_dupe =
  ranks_to_add_comp %>%
  filter(.data[['add_count']] > 1) %>%
  split(., .[['Rank.Name']])

# #?dplyr_data_masking

subtable_samefield = function(
  subtable, primary_field = 'Rank.Name', second_field = 'Pts.Name'
  ){
  primary_name = unique(subtable[[primary_field]])
  if (length(primary_name)>1){print(primary_name)}
  primary_name = primary_name[1] %>% 
    gsub(' Elementary School','', .) %>% 
    gsub(' High School','', .)
  comp_adds = subtable[[second_field]] %>% 
    gsub(' Elementary School','', .) %>% 
    gsub(' High School','', .)
   
  comp_row = str_match_vec(primary_name, comp_adds = comp_adds)
  
  comp_pct = comp_row[3] %>% as.numeric()
  if(comp_pct<75){print(c(unique(subtable[[second_field]]), comp_row))}
  
  dupe_correct = comp_row[2]
  dupe_index = match(dupe_correct,comp_adds)[1]
  dupe_correct = subtable[[second_field]][dupe_index]
  
  #subtable$dupe.correct = comp_pct
  
  return(subtable[subtable[[second_field]]==dupe_correct,])
}

#subtable_samefield(ranks_to_add_comp_dupe[16][[1]])

ranks_to_add_comp_dupe = 
  ranks_to_add_comp_dupe %>%
  lapply(., subtable_samefield) %>%
  do.call("rbind", .)


ranks_to_add_comp =
  rbind(
    ranks_to_add_comp %>%
      filter(.data[['add_count']] == 1),
    ranks_to_add_comp_dupe
  )


str_pct_comp = function(
  primary_str,
  second_str,
  replace = c('')
){
  comp_str = 
    stringdist(
      primary_str %>% 
        toupper() %>%
        str_replace_vector(., replace),
      second_str %>% 
        toupper() %>%
        str_replace_vector(., replace)
      )
  n_char_add  = nchar(primary_str)
  comp_pct    = 100-(comp_str/n_char_add*100)
  return(comp_pct)
}
  
ranks_to_add_comp =
  ranks_to_add_comp %>%
  mutate(
    Pct.Name = 
      str_pct_comp(Rank.Name,Pts.Name, 
                   replace=c(' Elementary School', ' High School')
                   )) %>%
  select(-add_count)

unsort_cols = c("Pct.Add","Pct.Name")
comp_cols = colnames(ranks_to_add_comp)
comp_sorted = sort_by_sep(comp_cols[!(comp_cols %in% unsort_cols)], sep='.', order=c(2,1), rev=c('',''))
ranks_to_add_comp = ranks_to_add_comp[, c(unsort_cols, comp_sorted)] %>% 
  arrange(Pct.Add, Pct.Name)


rank.cities.list = ranks_to_add_comp$Rank.City %>% unique() %>% toupper()

rank.cities.list[!(rank.cities.list %in% col.cities.list)]

comp_filter = (ranks_to_add_comp$Pct.Add!=100)&(ranks_to_add_comp$Pct.Name>=50)
ranks_to_add_comp = ranks_to_add_comp[ranks_to_add_comp$Rank.City %>% toupper() %in% boulder.cities.list, ] %>% arrange(Pct.Add)

ranks_to_add_comp = 
  ranks_to_add_comp %>% 
  merge(
    .,
    col.school.pts %>% 
      rename(Pts.Add = Address) %>%
      select(Pts.Add, geometry),
    on = 'Pts.Add'
  ) %>% 
  st_sf()
```

#### 3 fix bad pct.add
``` {r test}

col.school.join = 
  merge(
    ranks_to_add_comp %>% 
      select(Pts.Add) %>% 
      rename(Address = Pts.Add),
    col.school.rank %>% 
      st_drop_geometry() %>%
      mutate(Address = Address %>% toupper()),
    on='Address',
    all.x = T
  ) %>% 
  arrange(rank) %>% 
  distinct(., Address, .keep_all= TRUE)

col.school.join = 
  col.school.join %>%
  rename(
    ele.score.2020 = `average_standard_score_(2020-21)`,
    ele.score.2018 = `average_standard_score_(2018-19)`,
    ele.rank.2018 = `rank_(2018-19)`,
    ele.rank.2020 = rank,
    ele.name = school,
    ele.add = Address,
    ele.id = full_school_id
  ) %>%
  select(
    ele.name,
    ele.id,
    ele.add,
    ele.score.2020,
    ele.score.2018,
    ele.rank.2018,
    ele.rank.2020
    )

col.school.join

st_write(col.school.join %>% st_transform('EPSG:4326'), "data/boulder_county_elementary.geojson", delete_dsn = TRUE)

```

### H Ranks to Locations

``` {r locations_rank}
col.school.rank$ele.nn.id =
  st_nn_id_column(
    col.school.rank, # 11,364 rows
    col.school.pts, # 172 cols
    focus_id = '',
    compare_id = 'School_Coded'
  )

col.school.rank$ele.nn.dist =
  nndist(
    col.school.rank$geometry %>% as.ppp(.), # 11,364 rows
    col.school.pts$geometry %>% as.ppp(.) # 172 cols
  )
ele_rank_geom$ele.nn.dist_m = ele_rank_geom$ele.nn.dist/5280

string_dist_pct = function(first_col, second_col, upper=TRUE){
  if (upper==TRUE){
    first_col = toupper(first_col)
    second_col = toupper(second_col)
  }
  str_comp = 
    1 - (stringdist(
      first_col, 
      second_col, 
      method = "lv") / nchar(as.character(first_col)))
  return(str_comp)}

col.school.rank$district = 
          strsplit(col.school.rank$district, "District") %>% 
            as.data.frame() %>% 
            t %>% 
            data.frame(stringsAsFactors = F) %>% 
            pull(2) %>% gsub('No.', '', .) %>% str_trim(.)

school.fix = 
  dplyr::inner_join(
    col.school.rank %>% 
      select(
        ele.nn.id,
        school,
        address,
        district_id,
        district
        ) %>%
      rename(
        nn.id = ele.nn.id,
        rank.nme = school,
        rank.add = address,
        rank.dist.code = district_id,
        rank.dist.nme = district
        ) %>% 
      st_drop_geometry(.),
    col.school.pts %>% 
      select(
        School_Coded,
        School_Name,
        Address,
        District_Code,
        District_Name
      ) %>% 
      rename(
        nn.id = School_Coded,
        nn.nme = School_Name,
        nn.add = Address,
        nn.dist.code = District_Code,
        nn.dist.nme = District_Name
        ) %>%
      st_drop_geometry(.),
    by = 'nn.id'
  ) %>%
  mutate(
    pct.add = string_dist_pct(nn.add, rank.add),
    pct.nme = string_dist_pct(nn.nme, rank.nme),
    pct.dist.nme = string_dist_pct(nn.dist.nme, rank.dist.nme)
  )

colnames(col.school.rank)
glimpse(col.school.rank %>% arrange(district_id))
glimpse(col.school.pts %>% arrange(District_Code))


col_fix = colnames(fix)
col_splits = str_split(col_fix, '\\.', n=2) %>% 
  unlist(.) %>% matrix(., ncol=2, byrow=TRUE) %>%
  cbind(col_fix,.) %>% as_tibble(.)
colnames(col_splits) = c('col','s1','s2')
col_splits$s1 = gsub('pct','_pct', col_splits$s1)
col_order = col_splits[order(col_splits$s2, -rank(col_splits$s1)),]$col

view(fix[, col_order] %>% arrange(pct.nme))


view(fix[,c("address_full","geocode.add","geocode.pct")] %>% arrange(geocode.pct))
col.school.rank$geocode.add


#col.school.rank$geocode.pct = 
  





col.school.rank



hist(ele_rank_geom$ele.nn.dist_m, breaks='FD')

ele_rank_geom[ele_rank_geom$ele.nn.dist_m>20,]

setdiff(
  col.school.rank$school_id,
  boulder.sales$ele.nn.id
  
)

unique(boulder.sales$ele.nn.id) %>% sort(.)
unique(col.school.pts$School_Code) %>% sort(.)
unique(col.school.rank$school_id) %>% sort(.)


```


### E Pts to Sales


```{r schools}


st_geom_ids = function(compare_sf, compare_id){
  compare_geoms = compare_sf[,'geometry']
  compare_ids = compare_sf[[compare_id]]
  if (length(unique(compare_ids)) != length(compare_ids)){
    warning("there are duplicate ids")
    warning(length(compare_ids)-length(unique(compare_ids)))
  }
  rownames(compare_geoms) = compare_ids
  return(compare_geoms)
}

st_nn_id_column = function(
  focus_sf, compare_sf,
  focus_id='', compare_id=''){
  
  #compare_geoms = st_geom_ids(compare_sf, compare_id)
  
  compare_geoms = compare_sf$geometry
  compare_ids = compare_sf[[compare_id]]
  
  if (length(unique(compare_ids)) != length(compare_ids)){
    warning("there are duplicate ids")
    warning(length(compare_ids)-length(unique(compare_ids)))
  }
  
  nn_focus_compare = 
    st_nearest_feature(
      focus_sf,
      compare_geoms,
      check_crs = TRUE
      )
  
  nn_focus_ids = sapply(nn_focus_compare, function(i) compare_ids[i])
  
  return(nn_focus_ids)
}

boulder.sales$ele.nn.id =
  st_nn_id_column(
    boulder.sales, # 11,364 rows
    col.school.pts, # 172 cols
    #focus_id = 'MUSA_ID',
    compare_id = 'School_Code'
  ) %>%
  str_pad(., 4, pad = "0")

boulder.sales$ele.nn.dist =
  nndist(
    boulder.sales$geometry %>% as.ppp(.), # 11,364 rows
    col.school.pts$geometry %>% as.ppp(.) # 172 cols
  )


ggplot() + 
  # geom_sf(
  #   data = boulder.cities, 
  #   aes(fill=incorporated), 
  #   color='transparent') + 
  # geom_sf(
  #   data = col.school.pts, 
  #   aes(fill=school_name), 
  #   color='transparent') + 
  geom_cities() +
  geom_county() +
  geom_sf(
    data = col.school.pts
  ) + 
  # geom_text(
  #   data=boulder.cities.labels, check_overlap=TRUE,
  #   size = ifelse(boulder.cities.labels$size==2,2.5,2),
  #   fontface='bold', color='black',
  #   aes(x=lon,y=lat, label=name)) +
  theme(legend.position = "none") + 
  plot_limits(boulder.county %>% st_buffer(100000)) +
  mapTheme()

'0436' %in% col.school.pts$School_Code
fix
```

## 9 Assorted Variable Creation

```{r assorted}

boulder.sales$nbrBaths =  
  boulder.sales$nbrFullBaths + boulder.sales$nbrHalfBaths

# 3. Full Bathroom
boulder.variables = add_v(
  "nbrBaths",     3,    "Internal"
)

# i. Num of Bedrooms
boulder.variables = add_v(
  "nbrBedRoom",    1,    "Internal"
)

# 2. Main Square Foot
boulder.variables = add_v(
  "mainfloorSF",   2,    "Internal"
)


# N. Nearest Neighbor
boulder.variables = add_v(
  "lagPrice",      99,   "Spatial"
)

# 3. Built Year
boulder.variables = add_v(
  "EffectiveYear",   3,    "Internal"
)

```

## 10 Set Up boulder.data & 0/1 Partition

variables are one of these types:
1.	Internal characteristics (e.g. bedrooms)
2.	amenities/public services (e.g. proximity to parks)
3.	spatial structure (e.g. nearby prices)

Split up the data between sales prices known, and the sales prices that are set to 0 to be predicted 

```{r price_dataset}

ID_fields = c(
#   ID given by michael
  "MUSA_ID",
#   whether they should be predicted (1) or already have a price (0)
  "toPredict"
  )


boulder.data = boulder.sales[,c(
  ID_fields,
  boulder.variables$var_name,
  'geometry'
  )]

boulder.dv = boulder.variables[!boulder.variables$var_num %in% c(0,99), 'var_name']

boulder.predict.0 = boulder.data %>%
  filter(.,toPredict == 0)
boulder.predict.1 = boulder.data %>%
  filter(., toPredict == 1)

boulder.variables


glimpse(boulder.data)

```

