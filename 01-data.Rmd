# 1. Data
## 1.A Gathering Data
*Briefly describe your methods for gathering the data.*

### 1.A.1 Import Data
```{r import_sales}
print(getwd())
col_crs = st_crs('ESRI:102653')

studentData_path =
  "./data/studentData.geojson"
boulder.sales =
  st_read(studentData_path) %>% 
  st_set_crs('ESRI:102254') %>% 
  st_transform(., col_crs) %>%
  mutate(
    toPredict = toPredict %>% sapply(., as.character)
  )

boulder.sales$lagPrice = 0

boulder.variables = 
  data.frame(
# 0. Housing Sales Price
    var_name=c("price"),
    var_num=(0),
    var_type=('Dependent'))

add_v = function(vnme, vnum, vtype){
  if(vnme %in% boulder.variables[['var_name']]){
    print("didnt add since it is already in")
    return(boulder.variables)
    }
  else{
    return(rbind(boulder.variables,c(
    vnme, vnum, vtype
    )) %>% arrange(var_num))}}


```

### 1.A.2 Parcel Joins


```{r parcel}

# parcel_path =
#   "./data/Boulder_Parcels_20211009.geojson"
# boulder.parcel = st_read(parcel_path) %>%
#   rename(ID = OBJECTID, APN=PARCEL_NO) %>%
#   select(ID,APN) %>%
#   st_transform(., col_crs) %>% # North Col State Plane Feet
#   mutate(
#     geometry = st_make_valid(geometry),
#     area = st_area(geometry))
# attributes(boulder.parcel$area) = NULL
# boulder.parcel = boulder.parcel %>% filter(area>0)
# 
# address_path =
#   "./data/Boulder_AddressPts_20211009.geojson"
# boulder.address = st_read(address_path)%>%
#   st_transform(., col_crs)
# 
# acct_path =
#   "./data/Account_Parcels.csv"
# boulder.parcel.acct = read.csv(acct_path)
# 
# build_path =
#   "./data/Buildings.csv"
# boulder.parcel.build = read.csv(build_path)
# 
# land_path =
#   "./data/Land.csv"
# boulder.parcel.land = read.csv(land_path)
# 
# owner_path =
#   "./data/Owner_Address.csv"
# boulder.parcel.owner = read.csv(owner_path)

# permits =
#   "./data/Permits.csv"
# B.build = read.csv(build_path)

```

### 1.A.3 Parcel Clean

```{r parcel_clean}

# OG_len = nrow(boulder.parcel%>% st_drop_geometry())
# APN_len = nrow(boulder.parcel %>% st_drop_geometry() %>% distinct(., APN))
# ID_len = nrow(boulder.parcel %>% st_drop_geometry() %>% distinct(., ID, APN))
# area_len = nrow(boulder.parcel[boulder.parcel$area>0,] %>% st_drop_geometry() )
# 
# print(OG_len)
# print(OG_len-APN_len)
# print(OG_len-ID_len)
# print(OG_len-area_len)
# 
# # boulder.parcel[(boulder.parcel$area<=0)&(boulder.parcel$APN %in% dupe_APN),]
# 
# n_occur =
#   data.frame(table(boulder.parcel$APN)) %>%
#   rename(APN=Var1) %>% arrange(-Freq)
# 
# dupe_APN = n_occur[n_occur$Freq > 1,"APN"]
# B.dupe =
#   boulder.parcel[boulder.parcel$APN %in% dupe_APN,] %>% group_by(APN) %>%
#   summarize(geometry = st_union(geometry))
# 
# boulder.parcel[(boulder.parcel$APN == "157505036006")&
#         (boulder.parcel$area>0),]
# 
# boulder.county = boulder.parcel %>% st_union(.)
# 
# ggplot() +
#   geom_sf(data=boulder.county, lwd=.1, color='lightgrey')
# +
#   geom_sf(data=boulder.parcel, lwd=.1) +
#   geom_sf(data=B.dupe,
#           fill='pink', color='red') +
#   plot_limits(poly.geometry= B.dupe)
```

``` {r boundaries}

boulder.county = 
  st_read('data/boulder_county.geojson') %>%
  st_sf(., crs=col_crs)

boulder.cities = 
  st_read('data/boulder_cities.geojson') %>%
  st_sf(., crs=col_crs)

geom_county = function(
  sf_county = boulder.county,
  fill = 'transparent', color='black',
  lwd=1
  ){
    c_plot = geom_sf(data = sf_county, fill = fill, color=color,
          lwd=lwd)
    return(c_plot)}

geom_cities = function(
  sf_cities = boulder.cities,
  fill = 'transparent', color='grey',
  lwd=.1, linetype = "dashed"
  ){
    c_plot = geom_sf(data = sf_cities, fill = fill, color=color,
          lwd=lwd,linetype = linetype)
    return(c_plot)}
  
```


### 1.A.8 Neighborhoods

```{r plot_sfs}


boulder.nhoods = 
  st_read('data/boulder_neighborhoods.geojson') %>%
  st_sf(., crs=col_crs)


boulder.sales =
  boulder.sales %>% 
  #select_if(!names(.) %in% c('neighborhood')) %>%
  st_join(., boulder.nhoods)

boulder.sales %>%
  group_by(neighborhood) %>%
  summarize(
    house_count = n()
    )

boulder.nhoods =
  boulder.nhoods %>%
  merge(
    .,
    aggregate(boulder.sales$MUSA_ID,
            by=list(boulder.sales$neighborhood), FUN=length) %>%
      rename(neighborhood = Group.1, house_count=x),
    by = 'neighborhood', all.x=TRUE) 

boulder.nhoods$house_count[is.na(boulder.nhoods$house_count)] = 0


ggplot() + 
  # geom_sf(
  #   data = boulder.cities, 
  #   aes(fill=incorporated), 
  #   color='transparent') + 
  geom_sf(
    data = boulder.nhoods, 
    aes(fill=nhood_id), 
    color='grey50') + 
  geom_cities() + 
  geom_county() + 
  geom_text_sf(sf_to_labels(
    boulder.cities, 
    'name')) + 
   theme(legend.position = "none") + 
  mapTheme()

```

### 1.A.9 Assorted Variable Creation

```{r assorted}

boulder.sales$nbrBaths =  
  boulder.sales$nbrFullBaths + boulder.sales$nbrHalfBaths

# 3. Full Bathroom
boulder.variables = add_v(
  "nbrBaths",     3,    "Internal"
)

# 1. Num of Bedrooms
boulder.variables = add_v(
  "nbrBedRoom",    1,    "Internal"
)

# 2. Main Square Foot
boulder.variables = add_v(
  "mainfloorSF",   2,    "Internal"
)


# N. Nearest Neighbor
boulder.variables = add_v(
  "lagPrice",      99,   "Spatial"
)

# 3. Built Year
boulder.variables = add_v(
  "EffectiveYear",   3,    "Internal"
)

boulder.sales %>% 
  group_by(qualityCode) %>%
  st_drop_geometry(.) %>%
  summarize(qualityCodeDscr = first(qualityCodeDscr))

# 5. Quality of House by accessor
boulder.variables = add_v(
  "qualityCode",   5,    "Internal"
)

```

### 1.A.10 Set Up boulder.data & 0/1 Partition

variables are one of these types:
1.	Internal characteristics (e.g. bedrooms)
2.	amenities/public services (e.g. proximity to parks)
3.	spatial structure (e.g. nearby prices)

Split up the data between sales prices known, and the sales prices that are set to 0 to be predicted 

```{r price_dataset}

ID_fields = c(
#   ID given by michael
  "MUSA_ID",
#   whether they should be predicted (1) or already have a price (0)
  "toPredict",
#   neighborhoods -- geometries & IDs based on voting districts 
#     names based on zillow & city data
  "neighborhood",
  "nhood_id"
  )



boulder.data = boulder.sales[,c(
  ID_fields,
  boulder.variables$var_name,
  'geometry'
  )]

boulder.iv = boulder.variables[
  !boulder.variables$var_num %in% c(0,99), 'var_name']

boulder.predict.0 <- boulder.data %>%
  filter(.,
         toPredict == '0',
         price < 30000000
         )
boulder.predict.1 <- boulder.data %>%
  filter(., toPredict == '1')

boulder.variables

glimpse(boulder.data)

```

